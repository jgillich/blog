<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Jakob Gillich &middot; Personal blog
    
  </title>

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Minimalist, developer. <a href="mailto:jakob@gillich.me">Say hi</a></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item  active " href="/">Home</a>
    <a class="sidebar-nav-item " href="/post">Posts</a>

    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

  </nav>

  <div class="sidebar-item">
    <p>All content licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Jakob Gillich</a>
            <small>Personal blog</small>
          </h3>
        </div>
      </div>

      <div class="container content">





<div class="posts">
  
    <div class="post">
        <h1 class="post-title"><a href="https://jakob.gillich.me/post/2013-10-22-automated-backups-on-freebsd/">Automated Backups on FreeBSD</a></h1>
        <span class="post-date">Oct 22 2013</span>
        

<p>I recently had to think about a backup strategy. The FreeBSD manual <a href="http://www.freebsd.org/doc/en/books/handbook/backup-basics.html">has an entry</a> describing the method I used to use in the past:</p>

<blockquote>
<h3 id="19-10-6-do-nothing:a2e6c96426785eaa733abf9b7c2cf5a9">19.10.6. Do Nothing</h3>

<p>“Do nothing” is not a computer program, but it is the most widely used backup strategy. There are no initial costs. There is no backup schedule to follow. Just say no. If something happens to your data, grin and bear it!</p>

<p>If your time and data is worth little to nothing, then “Do nothing” is the most suitable backup program for the computer. But beware, FreeBSD is a useful tool and over time it can be used to create a valuable collection of files.</p>
</blockquote>

<p>To mount my backup space at Hetzner automatically, I used Samba and this fstab entry:</p>

<pre><code>//u12345@your-backup.de/backup /mnt/backup smbfs rw,late,-N,-I188.40.5.173
</code></pre>

<p>There is a post on the FreeBSD forums about this that I can&rsquo;t find anymore, but the missing space between the <code>-I</code> option and the IP address is not a typo!</p>

<p>The <code>-N</code> option tells Samba to not ask for a password so you need to add it to the <code>/etc/nsmb.conf</code>:</p>

<pre><code>[YOUR-BACKUP.DE:U12345]
password=yourpassword
</code></pre>

<p>Both the hostname and the username must be in uppercase!</p>

<p>The recommended tools for doing backups are <code>dump</code> (creates backups) and <code>restore</code> (restores backups).</p>

<p>Dump can create full and incremental backups. Unlike rsync, it will only backup mountpoints (aka devices), not directories. If you need more flexibility, you should take a look at rsync instead.</p>

<p>To do incremental backups, dump uses so called <em>dump levels</em>. Here is the explanation from the manpage:</p>

<blockquote>
<p>A level 0, full backup, guarantees the entire file
system is copied (but see also the -h option below). A level number above 0, incremental backup, tells dump to copy all files new or modified since the last dump of any lower level. The default level is 0.</p>
</blockquote>

<p>What this means is that dump stores a date when a backup finished and which dump level has been used and uses these to do further incremental backups. Here is how I do my automatic backups via cron:</p>

<pre><code>0 4 * * 0 /sbin/dump -0uLa -f /mnt/backup/root0 /
0 4 * * 1 /sbin/dump -1uLa -f /mnt/backup/root1 /
0 4 * * 2 /sbin/dump -2uLa -f /mnt/backup/root2 /
0 4 * * 3 /sbin/dump -3uLa -f /mnt/backup/root3 /
0 4 * * 4 /sbin/dump -4uLa -f /mnt/backup/root4 /
0 4 * * 5 /sbin/dump -5uLa -f /mnt/backup/root5 /
0 4 * * 6 /sbin/dump -6uLa -f /mnt/backup/root6 /
</code></pre>

<p>Each day of a week at 4 a.m., this will execute dump.</p>

<ul>
<li>On Sundays (day 0), it will do a full backup (dump level 0) of / and store it at <code>/mnt/backup/root0</code>.</li>
<li>On Mondays (day 1), it will do a incremental level 1 backup including  all changes since dump level 0 and store it at <code>/mnt/backup/root1</code>.</li>
<li>On Tuesdays (day 1), it will do a incremental level 2 backup including  all changes since dump level 1 and store it at <code>/mnt/backup/root2</code>.</li>
<li>&hellip;</li>
</ul>

<p>So what you get is a full backup every sunday and backups including the daily changes every other day of the week.</p>

<p>About the options:</p>

<ul>
<li>u: Tells dump to update the dumpfile at <code>/etc/dumpdates</code> automatically. Required for incremental backups to work.</li>
<li>L: Tells dump that it is working on a live file system so it will create a snapshot.</li>
<li>a: <a href="http://lists.freebsd.org/pipermail/freebsd-questions/2007-July/153164.html">Do not ask any questions</a>.</li>
<li>f: Target file.</li>
</ul>

<p>For a complete explanation of these options, read the dump manpage.</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://jakob.gillich.me/post/2013-10-19-fix-your-java_home/">Fix your JAVA_HOME</a></h1>
        <span class="post-date">Oct 19 2013</span>
        <p>Trying to run one of JetBrain&rsquo;s IDE&rsquo;s (WebStorm in my case), you might get this error message:</p>

<pre><code>ERROR: Cannot start WebStorm
No JDK found. Please validate either WEBIDE_JDK, JDK_HOME or JAVA_HOME environment variable points to valid JDK installation.
</code></pre>

<p>It is crazy how long it took me to find a solution for this. Most answers on the web are talking about Oracle&rsquo;s proprietary Java; I wanted to run it using OpenJDK instead.</p>

<p>But thanks to <a href="http://stackoverflow.com/a/11542973/941764">this</a> StackOverflow answer I was able to solve it. A pretty universal way to set $JAVA_HOME is this:</p>

<pre><code>JAVA_HOME=$(readlink -f /usr/bin/java | sed &quot;s:bin/java::&quot;)
</code></pre>

<p>On Fedora, $JAVA_HOME would now look like this:</p>

<pre><code>$ echo $JAVA_HOME
/usr/lib/jvm/java-1.7.0-openjdk-1.7.0.60-2.4.2.7.fc19.x86_64/jre/
</code></pre>

<p>But this path will change all the time.</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://jakob.gillich.me/post/2013-10-19-owncloud-client-configuration-folder/">ownCloud Client Configuration Folder</a></h1>
        <span class="post-date">Oct 19 2013</span>
        <p>Every time ownCloud screws up, I have to delete the configuration files to reset it completely. The location where these files are stored isn&rsquo;t really documented anywhere, so here is the path you have to rm:</p>

<pre><code>~/.local/share/data/ownCloud
</code></pre>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://jakob.gillich.me/post/2013-10-14-ghost-on-freebsd/">Ghost on FreeBSD</a></h1>
        <span class="post-date">Oct 14 2013</span>
        

<p><a href="http://ghost.org">Ghost</a> has been released to the public today. Finally! I could not try it earlier because I wasn&rsquo;t one of the Kickstarter backers. When I discovered the project, it was already way over their initial funding goal so I saw no reason to fund it.</p>

<p>If you never heard of it: It is a simple blogging software. Similar to Wordpress, but it looks better, has fewer features and it&rsquo;s written in Node.js instead of PHP.</p>

<p>After trying it out locally, I installed it in a jail on my FreeNAS box. The installation is not completely straightforward, here is what you have to do:</p>

<h4 id="1-install-the-necessary-dependencies:de02a8f5185e1dd51d89e047d0203376">1. Install the necessary dependencies</h4>

<p>Here is a list of all dependencies that you need:</p>

<ul>
<li>www/node</li>
<li>www/npm</li>
<li>databases/sqlite3</li>
</ul>

<p>Install them from the ports collection or the package manager of your choice.</p>

<p>Ghost requires the node-sqlite3 package, and that one caused me some problems. To build and install it properly, we will need the node-gyp package from npm:</p>

<pre><code>npm install node-gyp -g
</code></pre>

<h4 id="2-get-ghost-and-install-more-dependencies:de02a8f5185e1dd51d89e047d0203376">2. Get Ghost and install more dependencies</h4>

<p>Now we have to download and extract Ghost. Go to the <a href="http://ghost.org/download/">download page</a> and copy the latest download link, I will not keep the one below up to date.</p>

<pre><code>fetch http://ghost.org/zip/ghost-0.3.2.zip
mkdir ghost
unzip -d ghost ghost-0.3.2.zip
cd ghost
</code></pre>

<p>This step is different from the official instructions. We have to explicitly pass the path of our sqlite3 installation to <code>npm install</code> (all third-party software is installed to /usr/local by default on FreeBSD).</p>

<pre><code>npm install --production --sqlite=/usr/local
</code></pre>

<h4 id="3-adjust-configuration:de02a8f5185e1dd51d89e047d0203376">3. Adjust Configuration</h4>

<p>We are almost done! Before running it, you have to create and open the <code>config.js</code> with your favorite text editor.</p>

<pre><code>cp config.example.js config.js
ee config.js
</code></pre>

<p>Then find the <code>production</code> section and set these properties to whatever you want:</p>

<ul>
<li>url</li>
<li>host</li>
<li>port</li>
</ul>

<p><code>url</code> is used for all frontend links, very useful if you run Ghost through a reverse proxy.</p>

<p>Now we are ready to run it using the <code>npm start</code> command from within the Ghost directory. If you plan to run it in production mode, execute <code>setenv NODE_ENV production</code> first.</p>

<h4 id="4-gain-control:de02a8f5185e1dd51d89e047d0203376">4. Gain Control</h4>

<p>Forever is a nice tool that keeps your node processes running, well, forever. It&rsquo;s like the <code>service</code> command for Node.js. Thanks to npm, installation is easy:</p>

<pre><code>npm install -g forever
</code></pre>

<p>To manage the process, I wrote a little service script. Put this at <code>/usr/local/etc/rc.d/ghost</code> and make it executeable:</p>

<script src="https://gist.github.com/jgillich/7045531.js"></script>

<p>Before the above script will work, you also have to do this:</p>

<ul>
<li>Add the <code>ghost</code> user</li>
<li>Give the user write access to the database: <code>chown -R ghost content/data/</code></li>
<li>Same for the logfile: <code>chmod 777 /var/log/ghost</code></li>
<li>Install security/sudo</li>
</ul>

<p>Now you have a service that integrates very well and in a secure way with the rest of the system:</p>

<ul>
<li>Autostart on boot: Add <code>ghost_enable=&quot;YES&quot;</code> to your <code>/etc/rc.conf</code></li>
<li>Start manually: <code>service ghost [one]start</code></li>
<li>Stop manually: <code>service ghost [one]stop</code></li>
<li>Logs are stored at <code>/var/log/ghost</code></li>
</ul>

<p>I will probably create a port that will automate the whole process soon (just need to learn how to do it first). And please note that the one above is the first service script I ever wrote, it may break your system! If you know how to improve it, please leave a comment.</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://jakob.gillich.me/post/2013-10-14-apache-force-encryption-everywhere/">HTTPS Almost Everywhere</a></h1>
        <span class="post-date">Oct 14 2013</span>
        <p>I have a free SSL certificate from <a href="https://startssl.com/">StartSSL</a> for all my domains. To force HTTPS everywhere in Apache&rsquo;s httpd, I use the following virtual host:</p>

<pre><code>&lt;VirtualHost _default_:80&gt;
  RewriteEngine On
  RewriteCond %{HTTPS} off
  RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
&lt;/VirtualHost&gt;
</code></pre>

<p>Because it is <code>_default_</code>, we don&rsquo;t need a server name and it is still possible to create regular HTTP hosts by adding another virtual host. And all parameters are of course preserved when redirecting.</p>

    </div>
  
</div>

<div class="pagination">
  
  <span class="pagination-item older">Older</span>
  

  
  <a class="pagination-item newer" href="/page/2/">Newer</a>
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>

